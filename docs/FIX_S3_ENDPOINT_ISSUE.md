# S3 엔드포인트 문제 해결 가이드

## 문제 발견

**에러 메시지의 IP 주소(`52.219.204.42`)가 S3 관련 사이트로 확인됨**

이것은 **S3 엔드포인트 문제**입니다!

## 왜 S3 엔드포인트가 필요한가?

ECR은 이미지를 pull할 때:
1. **ECR API/DKR 엔드포인트**: 이미지 메타데이터 가져오기
2. **S3**: 실제 이미지 레이어 다운로드 ← **여기서 실패**

ECR은 이미지 레이어를 S3에 저장하므로, 이미지를 pull하려면 S3 접근도 필요합니다.

## 해결 방법

### 1단계: S3 엔드포인트 확인

**VPC → Endpoints**

`com.amazonaws.ap-northeast-2.s3` 엔드포인트가 있는지 확인:
- ✅ **있음**: 2단계로
- ❌ **없음**: 3단계에서 생성

### 2단계: 라우트 테이블 확인

**중요**: S3는 **게이트웨이 엔드포인트**이므로 인터페이스 엔드포인트와 다르게 **라우트 테이블**에 연결됩니다.

**확인 방법**:
1. **VPC → Route Tables**
2. **프라이빗 서브넷의 라우트 테이블 선택** (ECS 태스크가 사용하는 서브넷)
3. **Routes 탭** 확인
4. **다음과 같은 경로가 있는지 확인**:
   ```
   Destination: pl-xxxxx (10.0.0.0/8 또는 0.0.0.0/0)
   Target: vpce-xxxxx (S3 엔드포인트)
   ```

**문제 확인**:
- ❌ **없음**: S3 엔드포인트가 라우트 테이블에 연결되지 않음
- ✅ **있음**: 다른 문제 가능 (보안 그룹 등)

### 3단계: S3 엔드포인트 생성 또는 수정

#### S3 엔드포인트가 없는 경우

1. **VPC → Endpoints → Create Endpoint**

2. **설정**:
   - **Service category**: AWS services
   - **Service name**: 검색창에 `s3` 입력 → `com.amazonaws.ap-northeast-2.s3` 선택
   - **VPC**: ECS 태스크가 실행되는 VPC 선택
   - **Route tables**: ⚠️ **프라이빗 서브넷의 라우트 테이블 선택** (서브넷이 아님!)
     - 모든 태스크 서브넷의 라우트 테이블 체크
   - **Policy**: Full access (또는 필요한 권한만)
   - **Create endpoint**

#### S3 엔드포인트가 있지만 라우트 테이블에 없는 경우

1. **VPC → Endpoints → S3 엔드포인트 선택**

2. **Route tables 탭 → Edit route tables**

3. **프라이빗 서브넷의 라우트 테이블 추가**:
   - ECS 태스크가 사용하는 모든 프라이빗 서브넷의 라우트 테이블 체크
   - ⚠️ **서브넷이 아니라 라우트 테이블**임을 주의!

4. **Save changes**

### 4단계: 변경 확인

**VPC → Route Tables → 프라이빗 서브넷의 라우트 테이블 → Routes 탭**

다음과 같은 경로가 추가되었는지 확인:
```
Destination          Target
pl-xxxxx (10.0.0.0/8)  vpce-xxxxx (S3 엔드포인트)
```

또는

```
Destination          Target
0.0.0.0/0            vpce-xxxxx (S3 엔드포인트)
```

## S3 엔드포인트 특징

### 게이트웨이 엔드포인트 vs 인터페이스 엔드포인트

| 항목 | ECR (인터페이스) | S3 (게이트웨이) |
|------|-----------------|----------------|
| 연결 방식 | 서브넷에 연결 | 라우트 테이블에 연결 |
| IP 주소 | 프라이빗 IP 할당 | IP 없음 (라우팅만) |
| 비용 | 시간당 $0.01/AZ | 무료 |
| 보안 그룹 | 필요 | 불필요 |
| Private DNS | 설정 가능 | **설정 불가능** (옵션 없음) |

### 왜 S3는 Private DNS가 없나?

- **게이트웨이 엔드포인트**: IP 주소를 할당하지 않고 라우트 테이블만 사용
- **인터페이스 엔드포인트**: 프라이빗 IP를 할당하고 DNS 이름을 프라이빗 IP로 매핑
- S3는 게이트웨이 방식이므로 Private DNS 설정이 필요 없고, 옵션 자체가 없습니다

### 왜 S3는 라우트 테이블에 연결하나?

- 게이트웨이 엔드포인트는 실제 네트워크 인터페이스를 생성하지 않음
- 라우트 테이블에 경로를 추가하여 S3 트래픽을 자동으로 라우팅
- Prefix List를 사용하여 S3 트래픽만 엔드포인트로 라우팅

## 확인 체크리스트

배포 전 확인:

✅ **1. S3 엔드포인트 존재**
   - VPC → Endpoints에서 `com.amazonaws.ap-northeast-2.s3` 확인

✅ **2. 라우트 테이블 연결**
   - 프라이빗 서브넷의 모든 라우트 테이블에 S3 엔드포인트 경로 추가

✅ **3. ECR 엔드포인트**
   - ECR API와 ECR DKR 엔드포인트가 모든 프라이빗 서브넷에 연결

✅ **4. 보안 그룹**
   - ECR 엔드포인트와 태스크 간 통신 허용

## 예상 결과

S3 엔드포인트를 올바르게 설정하면:
- ✅ 이미지 레이어 다운로드 성공
- ✅ 첫 시도 성공
- ✅ 배포 시간: 11분 → 2-3분
- ✅ 실패 태스크 없음

## 주의사항

- S3 엔드포인트는 **즉시 적용**됩니다 (재부팅 불필요)
- 라우트 테이블 변경도 즉시 적용
- 기존 실행 중인 태스크는 영향 없음
- 다음 배포부터 효과 적용

