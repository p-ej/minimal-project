# ECS νƒμ¤ν¬ λ„¤νΈμ›ν¬ μ—°κ²° λ¬Έμ  ν•΄κ²° κ°€μ΄λ“

## λ°μƒν•λ” μ—λ¬λ“¤

### 1. ECR μΈμ¦ ν† ν° μ”μ²­ μ‹¤ν¨
```
ResourceInitializationError: unable to pull secrets or registry auth
operation error ECR: GetAuthorizationToken, exceeded maximum number of attempts
dial tcp 54.180.184.238:443: i/o timeout
```

### 2. μ»¨ν…μ΄λ„ μ΄λ―Έμ§€ λ‹¤μ΄λ΅λ“ μ‹¤ν¨
```
CannotPullContainerError: failed to do request
dial tcp 3.5.188.72:443: i/o timeout
```

## λ¬Έμ  μ›μΈ

ECS νƒμ¤ν¬κ°€ **ν”„λΌμ΄λΉ— μ„λΈλ„·**μ—μ„ μ‹¤ν–‰λλ”λ°, μΈν„°λ„· λλ” AWS μ„λΉ„μ¤(ECR, S3)μ— μ ‘κ·Όν•  μ μλ” λ„¤νΈμ›ν¬ κ²½λ΅κ°€ μ—†μ–΄μ„ λ°μƒν•©λ‹λ‹¤.

- β… **CI/CDλ” μ„±κ³µ**: GitHub Actions λ¬λ„λ” νΌλΈ”λ¦­ μΈν„°λ„·μ—μ„ μ‹¤ν–‰λλ―€λ΅ ECR μ ‘κ·Ό κ°€λ¥
- β **ECS νƒμ¤ν¬ μ‹¤ν¨**: ν”„λΌμ΄λΉ— μ„λΈλ„·μ νƒμ¤ν¬κ°€ ECR λ μ§€μ¤νΈλ¦¬μ— μ ‘κ·Ό λ¶κ°€

## ν•΄κ²° λ°©λ²•

### λ°©λ²• 1: VPC μ—”λ“ν¬μΈνΈ μƒμ„± (κ¶μ¥ - λΉ„μ© ν¨μ¨μ )

VPC μ—”λ“ν¬μΈνΈλ¥Ό μ‚¬μ©ν•λ©΄ μΈν„°λ„· κ²½μ  μ—†μ΄ AWS μ„λΉ„μ¤μ— μ ‘κ·Όν•  μ μμ–΄ **NAT Gatewayλ³΄λ‹¤ λΉ„μ© ν¨μ¨μ **μ…λ‹λ‹¤.

#### 1-1. ECR API μ—”λ“ν¬μΈνΈ μƒμ„± (μΈμ¦ ν† ν°μ©)

1. **AWS Console β†’ VPC β†’ Endpoints β†’ Create Endpoint**

2. **μ„¤μ •**:
   - **Service category**: AWS services
   - **Service name**: `com.amazonaws.ap-northeast-2.ecr.api` μ„ νƒ
   - **VPC**: ECS νƒμ¤ν¬κ°€ μ‹¤ν–‰λλ” VPC μ„ νƒ
   - **Subnets**: νƒμ¤ν¬κ°€ μ‚¬μ©ν•λ” **λ¨λ“  μ„λΈλ„·** μ„ νƒ (κ°€μ© μμ—­λ³„)
   - **Security group**: 
     - κΈ°μ΅΄ λ³΄μ• κ·Έλ£Ή μ‚¬μ© λλ” μƒλ΅ μƒμ„±
     - **μ•„μ›ƒλ°”μ΄λ“ κ·μΉ™**: HTTPS(443) ν—μ© (κΈ°λ³Έ μ κ³µ κ·μΉ™ μ‚¬μ© κ°€λ¥)
   - **Policy**: Full access
   - **Enable Private DNS name**: β… μ²΄ν¬ (κ¶μ¥)

3. **Create endpoint**

#### 1-2. ECR Docker λ μ§€μ¤νΈλ¦¬ μ—”λ“ν¬μΈνΈ μƒμ„± (μ΄λ―Έμ§€ λ‹¤μ΄λ΅λ“μ©)

1. **λ™μΌν•κ² Create Endpoint**

2. **μ„¤μ •**:
   - **Service name**: `com.amazonaws.ap-northeast-2.ecr.dkr` μ„ νƒ
   - λ‚λ¨Έμ§€λ” 1-1κ³Ό λ™μΌν• VPC, μ„λΈλ„·, λ³΄μ• κ·Έλ£Ή μ‚¬μ©

#### 1-3. S3 κ²μ΄νΈμ›¨μ΄ μ—”λ“ν¬μΈνΈ μƒμ„± (μ΄λ―Έμ§€ λ μ΄μ–΄ μ €μ¥μ©)

1. **Create Endpoint**

2. **μ„¤μ •**:
   - **Service name**: `com.amazonaws.ap-northeast-2.s3` μ„ νƒ
   - **VPC**: λ™μΌν• VPC
   - **Route tables**: νƒμ¤ν¬ μ„λΈλ„·μ **λΌμ°νΈ ν…μ΄λΈ”** μ„ νƒ (μ„λΈλ„·μ΄ μ•„λ‹ λΌμ°νΈ ν…μ΄λΈ”!)
   - **Policy**: Full access

π’΅ **μ™ S3 μ—”λ“ν¬μΈνΈλ„ ν•„μ”ν•κ°€?**
- ECRμ€ μ΄λ―Έμ§€ λ μ΄μ–΄λ¥Ό S3μ— μ €μ¥ν•©λ‹λ‹¤
- μ΄λ―Έμ§€ λ‹¤μ΄λ΅λ“ μ‹ S3μ—μ„λ„ λ μ΄μ–΄λ¥Ό κ°€μ Έμ™€μ•Ό ν•©λ‹λ‹¤

### λ°©λ²• 2: NAT Gateway μ‚¬μ© (κΈ°μ΅΄ λ°©λ²•)

VPC μ—”λ“ν¬μΈνΈ λ€μ‹  NAT Gatewayλ¥Ό μ‚¬μ©ν•  μλ„ μμ§€λ§, **λΉ„μ©μ΄ λ” λ†’μµλ‹λ‹¤**.

1. **NAT Gateway μƒμ„±**:
   - νΌλΈ”λ¦­ μ„λΈλ„·μ— NAT Gateway μƒμ„±
   - Elastic IP ν• λ‹Ή

2. **λΌμ°νΈ ν…μ΄λΈ” μ„¤μ •**:
   - ν”„λΌμ΄λΉ— μ„λΈλ„·μ λΌμ°νΈ ν…μ΄λΈ”μ— NAT Gatewayλ¥Ό λ€μƒμΌλ΅ ν•λ” `0.0.0.0/0` λΌμ°νΈ μ¶”κ°€

3. **λ³΄μ• κ·Έλ£Ή ν™•μΈ**:
   - νƒμ¤ν¬ λ³΄μ• κ·Έλ£Ήμ μ•„μ›ƒλ°”μ΄λ“ κ·μΉ™μ— HTTPS(443) ν—μ©

## μ—”λ“ν¬μΈνΈ μƒμ„± ν›„ ν™•μΈ

### 1. μ—”λ“ν¬μΈνΈ μƒνƒ ν™•μΈ

```bash
# AWS CLI
aws ec2 describe-vpc-endpoints --vpc-endpoint-ids <endpoint-id>
```

**μƒνƒκ°€ `available`μ΄μ–΄μ•Ό ν•©λ‹λ‹¤.**

### 2. λΌμ°νΈ ν…μ΄λΈ” ν™•μΈ

S3 κ²μ΄νΈμ›¨μ΄ μ—”λ“ν¬μΈνΈλ” λΌμ°νΈ ν…μ΄λΈ”μ— μλ™μΌλ΅ κ²½λ΅κ°€ μ¶”κ°€λ©λ‹λ‹¤:
- `pl-xxxxxxxxx` (VPC μ—”λ“ν¬μΈνΈ Prefix List) β†’ `vpce-xxxxxxxxx`

### 3. λ³΄μ• κ·Έλ£Ή ν™•μΈ

ECR μ—”λ“ν¬μΈνΈμ λ³΄μ• κ·Έλ£Ήμ΄ νƒμ¤ν¬ λ³΄μ• κ·Έλ£Ήκ³Ό μ—°κ²°λμ–΄ μλ”μ§€ ν™•μΈ:
- ECR μ—”λ“ν¬μΈνΈ λ³΄μ• κ·Έλ£Ήμ **μΈλ°”μ΄λ“ κ·μΉ™**: νƒμ¤ν¬ λ³΄μ• κ·Έλ£Ήμ—μ„ HTTPS(443) ν—μ©
- λλ” κ°™μ€ λ³΄μ• κ·Έλ£Ή μ‚¬μ©

## λ¬Έμ  ν•΄κ²° ν™•μΈ

### 1. μƒ νƒμ¤ν¬ μ‹¤ν–‰

ECS μ„λΉ„μ¤κ°€ μƒλ΅μ΄ νƒμ¤ν¬λ¥Ό μ‹¤ν–‰ν•  λ•:
- β… ECR μΈμ¦ ν† ν° μ”μ²­ μ„±κ³µ
- β… μ»¨ν…μ΄λ„ μ΄λ―Έμ§€ λ‹¤μ΄λ΅λ“ μ„±κ³µ
- β… νƒμ¤ν¬ μ •μƒ μ‹¤ν–‰

### 2. λ°°ν¬ μ‹κ°„ λ‹¨μ¶•

μ΄μ „μ—λ” μ‹¤ν¨ν• νƒμ¤ν¬κ°€ μ¬μ‹λ„λλ©° 15λ¶„ μ •λ„ κ±Έλ Έμ§€λ§, μ—”λ“ν¬μΈνΈ μ„¤μ • ν›„μ—λ”:
- μ²« μ‹λ„μ— μ„±κ³µ
- λ°°ν¬ μ‹κ°„ ν¬κ² λ‹¨μ¶• (2-3λ¶„ λ‚΄)

## μ¶”κ°€ μµμ ν™”

### 1. GitHub Actions λ°°ν¬ μ†λ„ ν–¥μƒ

`.github/workflows/deploy.yml`μ—μ„:

```yaml
- name: Deploy to ECS
  uses: aws-actions/amazon-ecs-deploy-task-definition@v1
  with:
    task-definition: ${{ steps.taskdef.outputs.task-definition }}
    service: ${{ env.ECS_SERVICE }}
    cluster: ${{ env.ECS_CLUSTER }}
    wait-for-service-stability: true  # λλ” falseλ΅ μ„¤μ •ν•μ—¬ λΉ λ¥Έ λ°°ν¬
```

**μµμ…**:
- `wait-for-service-stability: false`: λ°°ν¬ μ™„λ£λ¥Ό κΈ°λ‹¤λ¦¬μ§€ μ•μ (λΉ λ¦„)
- `wait-for-minutes: 5`: μµλ€ 5λ¶„λ§ λ€κΈ°

### 2. νƒμ¤ν¬ μ‹¤ν–‰ μ—­ν•  κ¶ν• ν™•μΈ

ECS νƒμ¤ν¬ μ‹¤ν–‰ μ—­ν• (`ecs-task-execution-role`)μ— λ‹¤μ κ¶ν•μ΄ μλ”μ§€ ν™•μΈ:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ecr:GetAuthorizationToken",
        "ecr:BatchCheckLayerAvailability",
        "ecr:GetDownloadUrlForLayer",
        "ecr:BatchGetImage"
      ],
      "Resource": "*"
    }
  ]
}
```

λλ” AWS κ΄€λ¦¬ν• μ •μ±…:
- `AmazonECSTaskExecutionRolePolicy` μ‚¬μ©

## λΉ„μ© λΉ„κµ

### VPC μ—”λ“ν¬μΈνΈ (κ¶μ¥)
- μΈν„°νμ΄μ¤ μ—”λ“ν¬μΈνΈ: μ‹κ°„λ‹Ή μ•½ $0.01/μ‹κ°„ Γ— 2κ° = μ•½ $14.4/μ›”
- κ²μ΄νΈμ›¨μ΄ μ—”λ“ν¬μΈνΈ (S3): λ¬΄λ£
- **μ΄ μ•½ $14.4/μ›”**

### NAT Gateway
- μ‹κ°„λ‹Ή μ•½ $0.045/μ‹κ°„ = μ•½ $32.4/μ›”
- λ°μ΄ν„° μ „μ†΅ λΉ„μ© μ¶”κ°€ (GBλ‹Ή $0.045)
- **μµμ† $32.4/μ›” + μ „μ†΅ λΉ„μ©**

**κ²°λ΅ **: VPC μ—”λ“ν¬μΈνΈκ°€ μ•½ **50% μ΄μƒ μ €λ ΄**ν•©λ‹λ‹¤.

## ECS λ΅¤λ§ λ°°ν¬ λ™μ‘ μ΄ν•΄

### μ™ μΌλ¶€ νƒμ¤ν¬λ” μ‹¤ν¨ν•λ”λ° λ°°ν¬λ” μ„±κ³µν•λ‚μ”?

ECS μ„λΉ„μ¤λ” **λ΅¤λ§ λ°°ν¬(Rolling Deployment)** μ „λµμ„ μ‚¬μ©ν•©λ‹λ‹¤:

1. **μƒ νƒμ¤ν¬ μ •μλ΅ μ—¬λ¬ νƒμ¤ν¬ μƒμ„± μ‹λ„**
   - μ„λΉ„μ¤ μ„¤μ •μ— λ”°λΌ λ™μ‹μ— μ—¬λ¬ νƒμ¤ν¬λ¥Ό μƒμ„±
   - μ: `desiredCount: 2`λ©΄ 2κ°μ μƒ νƒμ¤ν¬ μƒμ„± μ‹λ„

2. **μΌλ¶€ νƒμ¤ν¬ μ‹¤ν¨**
   - ν”„λΌμ΄λΉ— μ„λΈλ„·μ νƒμ¤ν¬κ°€ ECRμ— μ ‘κ·Ό λ¶κ°€ β†’ νƒ€μ„μ•„μ›ƒ
   - μ‹¤ν¨ν• νƒμ¤ν¬λ” μ¤‘μ§€λ¨

3. **μ¬μ‹λ„ λ° μΌλ¶€ μ„±κ³µ**
   - ECSκ°€ μλ™μΌλ΅ μƒ νƒμ¤ν¬ μ¬μ‹λ„
   - λ„¤νΈμ›ν¬ μƒν™©μ— λ”°λΌ μΌλ¶€ νƒμ¤ν¬λ” μ„±κ³µ:
     - NAT Gatewayκ°€ μμ–΄μ„ λλ¦¬κ² λ™μ‘
     - μΌμ‹μ μΈ λ„¤νΈμ›ν¬ λ³µκµ¬
     - λ‹¤λ¥Έ μ„λΈλ„·μ—μ„ μ‹¤ν–‰λ νƒμ¤ν¬κ°€ μ„±κ³µ

4. **μµμΆ… λ°°ν¬ μ™„λ£**
   - μ„±κ³µν• νƒμ¤ν¬κ°€ `RUNNING` μƒνƒκ°€ λλ©΄ λ°°ν¬ μ™„λ£λ΅ κ°„μ£Ό
   - μ‹¤ν¨ν• νƒμ¤ν¬λ” μλ™μΌλ΅ μ •λ¦¬

### λ¬Έμ μ 

μ΄ λ™μ‘μ€ **μ •μƒμ΄μ§€λ§ λΉ„ν¨μ¨μ **μ…λ‹λ‹¤:
- β λ°°ν¬ μ‹κ°„μ΄ κΈΈμ–΄μ§ (15λ¶„)
- β λ¶ν•„μ”ν• νƒμ¤ν¬ μ¬μ‹λ„λ΅ λ¦¬μ†μ¤ λ‚­λΉ„
- β λ¶μ•μ •ν• λ°°ν¬ (μ‹¤ν¨/μ„±κ³µμ΄ ν™•λ¥ μ )
- β λ΅κ·Έμ— μ—λ¬κ°€ κ³„μ† κΈ°λ΅λ¨

### ν•΄κ²° ν›„ μμƒ λ™μ‘

VPC μ—”λ“ν¬μΈνΈλ¥Ό μ„¤μ •ν•λ©΄:
- β… λ¨λ“  νƒμ¤ν¬κ°€ μ²« μ‹λ„μ— μ„±κ³µ
- β… λ°°ν¬ μ‹κ°„ λ‹¨μ¶• (2-3λ¶„)
- β… μ•μ •μ μΈ λ°°ν¬
- β… μ—λ¬ μ—†μ΄ κΉ”λ”ν• λ°°ν¬

## νΈλ¬λΈ”μν…

### μ—¬μ „ν νƒ€μ„μ•„μ›ƒμ΄ λ°μƒν•λ‹¤λ©΄?

1. **μ—”λ“ν¬μΈνΈ μƒνƒ ν™•μΈ**: λ¨λ“  μ—”λ“ν¬μΈνΈκ°€ `available` μƒνƒμΈμ§€
2. **λ³΄μ• κ·Έλ£Ή ν™•μΈ**: ECR μ—”λ“ν¬μΈνΈμ™€ νƒμ¤ν¬ κ°„ ν†µμ‹  ν—μ© μ—¬λ¶€
3. **λΌμ°νΈ ν…μ΄λΈ” ν™•μΈ**: S3 μ—”λ“ν¬μΈνΈκ°€ μ¬λ°”λ¥Έ λΌμ°νΈ ν…μ΄λΈ”μ— μ—°κ²°λμ—λ”μ§€
4. **νƒμ¤ν¬ μ„λΈλ„· ν™•μΈ**: μ—”λ“ν¬μΈνΈκ°€ νƒμ¤ν¬μ™€ κ°™μ€ μ„λΈλ„·/κ°€μ© μμ—­μ— μλ”μ§€

### μ—”λ“ν¬μΈνΈ μƒμ„± μ‹¤ν¨

- **VPCκ°€ μ¶©λ¶„ν ν°μ§€ ν™•μΈ**: VPCμ— μ‚¬μ© κ°€λ¥ν• IP μ£Όμ†κ°€ μ¶©λ¶„ν•΄μ•Ό ν•¨
- **μ„λΉ„μ¤ μ΄λ¦„ ν™•μΈ**: λ¦¬μ „ μ΄λ¦„(`ap-northeast-2`)μ΄ μ •ν™•ν•μ§€
- **κ¶ν• ν™•μΈ**: VPC μ—”λ“ν¬μΈνΈ μƒμ„± κ¶ν•μ΄ μλ”μ§€

