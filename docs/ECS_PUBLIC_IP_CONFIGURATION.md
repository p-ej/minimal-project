# ECS 태스크 퍼블릭 IP 설정 가이드

## 질문: "퍼블릭 IP 자동 지정"을 체크해야 하나요?

## 답변: ❌ **체크 해제 (비활성화)** 해야 합니다!

## 이유

### 현재 구성
- ✅ **프라이빗 서브넷에서 태스크 실행**
- ✅ **VPC 엔드포인트 사용** (ECR, S3)
- ✅ **NAT Gateway 사용** (외부 서비스 접근용, 선택사항)

### 퍼블릭 IP를 활성화하면 안 되는 이유

#### 1. 보안 문제
- ❌ **태스크가 인터넷에 직접 노출됨**
- ❌ **보안 그룹만으로는 충분하지 않음**
- ❌ **불필요한 공격 표면 증가**

#### 2. 네트워크 아키텍처 문제
- ❌ **VPC 엔드포인트와 충돌 가능**
- ❌ **프라이빗 서브넷의 목적과 맞지 않음**
- ❌ **라우팅 문제 발생 가능**

#### 3. 비용 문제
- ❌ **퍼블릭 IP는 무료이지만, NAT Gateway를 우회하게 됨**
- ❌ **VPC 엔드포인트 사용 시 불필요**

## 올바른 설정

### ✅ 프라이빗 서브넷 + 퍼블릭 IP 없음

**구성**:
- **서브넷**: 프라이빗 서브넷만 선택
- **퍼블릭 IP**: ❌ **체크 해제 (비활성화)**
- **네트워크 모드**: `awsvpc` (Fargate 기본값)

**네트워크 경로**:
- **VPC 엔드포인트**: ECR, S3 접근 (무료/저렴)
- **NAT Gateway**: 다른 외부 서비스 접근 (선택사항)

## 설정 방법

### ECS 서비스 수정

1. **ECS → Clusters → 클러스터 → Services → 서비스 선택**
2. **Update** 클릭
3. **Networking** 섹션으로 스크롤
4. **Auto-assign public IP** 확인:
   - ❌ **체크 해제 (Disable)**
5. **Subnets** 확인:
   - ✅ **프라이빗 서브넷만 선택**
6. **Update** 클릭

### ⚠️ 중요: 태스크 정의에는 네트워크 구성 포함 불가!

**태스크 정의 (`ecs-task-def.json`)에는 네트워크 구성을 포함할 수 없습니다!**

✅ **태스크 정의에 포함 가능한 것**:
```json
{
  "networkMode": "awsvpc",  // Fargate 필수
  // 네트워크 구성은 여기에 없음!
}
```

❌ **태스크 정의에 포함 불가능한 것**:
- `networkConfiguration`
- `assignPublicIp`
- `subnets`
- `securityGroups`

**네트워크 구성은 ECS 서비스 레벨에서만 관리됩니다!**

**올바른 태스크 정의 예시**:
```json
{
  "family": "role-nestjs-second",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "1024",
  "memory": "3072",
  "executionRoleArn": "role-nestjs",
  "taskRoleArn": "role-nestjs",
  "containerDefinitions": [...]
  // 네트워크 구성은 여기에 없음!
}
```

## 퍼블릭 IP가 필요한 경우 (예외)

### ❌ 일반적으로 필요 없음

**다음 경우에만 고려**:
- 퍼블릭 서브넷에서 태스크 실행 (비추천)
- NAT Gateway 없이 외부 서비스 접근 필요
- 특별한 보안 요구사항

**하지만**:
- VPC 엔드포인트 사용 시 불필요
- 보안 위험 증가
- 프라이빗 서브넷 사용 권장

## 현재 프로젝트 권장 설정

### ✅ 권장 구성

```
✅ 서브넷: 프라이빗 서브넷 2개 (다중 AZ)
✅ 퍼블릭 IP: 비활성화 (체크 해제)
✅ 보안 그룹: 적절한 규칙 설정
✅ VPC 엔드포인트: ECR API, ECR DKR, S3 Gateway
✅ NAT Gateway: 선택사항 (VPC 엔드포인트만 사용 가능)
```

### ❌ 피해야 할 구성

```
❌ 퍼블릭 서브넷에서 태스크 실행
❌ 퍼블릭 IP 활성화
❌ VPC 엔드포인트 없이 NAT Gateway만 사용
```

## 확인 방법

### 현재 설정 확인

1. **ECS → Services → 서비스 선택 → Networking 탭**
2. **Auto-assign public IP** 확인:
   - ❌ **Disabled** 또는 **체크 해제** → ✅ 정상
   - ✅ **Enabled** 또는 **체크됨** → ❌ 수정 필요

2. **실행 중인 태스크 확인**:
   - **ECS → Tasks → 태스크 선택 → Details → Network**
   - **Public IP** 확인:
     - ❌ **없음** 또는 **-** → ✅ 정상
     - ✅ **IP 주소 있음** → ❌ 수정 필요

## 수정 후 확인

### 배포 후 확인

1. **새 태스크 배포**
2. **태스크 Details → Network** 확인
3. **Public IP가 없는지 확인**
4. **VPC 엔드포인트를 통한 ECR/S3 접근 확인**

### 테스트

- ✅ **태스크가 정상 시작됨**
- ✅ **ECR에서 이미지 pull 성공**
- ✅ **S3 접근 가능 (필요한 경우)**
- ✅ **퍼블릭 IP 없음**

## 결론

### ✅ 올바른 설정
- **퍼블릭 IP**: ❌ **체크 해제 (비활성화)**
- **서브넷**: ✅ **프라이빗 서브넷만**
- **VPC 엔드포인트**: ✅ **활성화**

### ⚠️ 주의사항
- 퍼블릭 IP를 활성화하면 보안 문제와 네트워크 문제 발생 가능
- 프라이빗 서브넷에서 실행하는 태스크는 퍼블릭 IP가 필요 없음
- VPC 엔드포인트를 사용하면 NAT Gateway 없이도 AWS 서비스 접근 가능

