# ECS 서브넷 구성 가이드

## 질문: ECS 클러스터에 퍼블릭 2개, 프라이빗 2개 서브넷이 연결되어 있는데 정상인가요?

## 답변: ✅ 정상입니다!

### 일반적인 AWS VPC 구성

**표준 구성**:
- **가용 영역(AZ) 2개**: 고가용성(HA)을 위해
- **각 AZ마다**:
  - 퍼블릭 서브넷 1개
  - 프라이빗 서브넷 1개
- **총 4개 서브넷**: 2개 AZ × 2개 서브넷 타입 = 4개

### 각 서브넷의 역할

#### 퍼블릭 서브넷 (2개)
**용도**:
- ✅ NAT Gateway
- ✅ 인터넷 게이트웨이(IGW) 연결
- ✅ 로드밸런서 (ALB/NLB)
- ✅ Bastion 호스트 (선택사항)

**ECS 태스크**: ❌ **실행되지 않음**

#### 프라이빗 서브넷 (2개)
**용도**:
- ✅ ECS Fargate 태스크 실행
- ✅ RDS 데이터베이스
- ✅ 내부 서비스

**ECS 태스크**: ✅ **여기서 실행됨**

## ECS 클러스터 vs 서비스 서브넷 설정

### 클러스터 레벨 (Cluster)
- **모든 서브넷 연결 가능**: 클러스터는 서브넷을 "알고" 있기만 함
- **실제 태스크 실행과 무관**: 클러스터 설정만으로는 태스크가 실행되지 않음

### 서비스 레벨 (Service) ⚠️ 중요
- **실제 태스크 실행 서브넷**: 서비스 설정에서 선택한 서브넷만 사용
- **일반적으로 프라이빗 서브넷만 선택**: Fargate 태스크는 프라이빗에서 실행

## 확인 방법

### 1. 클러스터에 연결된 서브넷 확인
1. **ECS → Clusters → 클러스터 선택**
2. **Networking 탭** 확인
3. **모든 서브넷 목록** 표시 (퍼블릭 + 프라이빗)

**결과**: 4개 모두 표시되어도 정상 ✅

### 2. 서비스에 설정된 서브넷 확인 (중요!)
1. **ECS → Clusters → 클러스터 → Services → 서비스 선택**
2. **Networking 탭** 확인
3. **Subnets** 목록 확인

**예상 결과**:
- ✅ 프라이빗 서브넷 2개만 표시 (정상)
- ❌ 퍼블릭 서브넷이 포함되어 있다면 문제 (태스크가 퍼블릭에서 실행될 수 있음)

### 3. 실제 태스크 실행 서브넷 확인
1. **ECS → Tasks → 실행 중인 태스크 선택**
2. **Details 탭 → Network** 섹션
3. **Subnet ID** 확인

**예상 결과**:
- ✅ 프라이빗 서브넷 ID만 표시
- ❌ 퍼블릭 서브넷 ID가 표시되면 문제

## VPC 엔드포인트 연결 대상

### ✅ 연결해야 할 서브넷
**프라이빗 서브넷 2개만**:
- ECR API 엔드포인트
- ECR DKR 엔드포인트
- S3 Gateway 엔드포인트

### ❌ 연결 불필요한 서브넷
**퍼블릭 서브넷 2개**:
- 태스크가 실행되지 않으므로 엔드포인트 연결 불필요
- 하지만 연결해도 문제는 없음 (불필요한 비용만 발생)

## 라우트 테이블 확인

### 프라이빗 서브넷 라우트 테이블
**필수 경로**:
- `0.0.0.0/0` → NAT Gateway (외부 서비스 접근용)
- `pl-xxxxx` (S3 Prefix List) → `vpce-xxxxx` (S3 엔드포인트)
- `10.0.0.0/16` (VPC 내부) → `local`

### 퍼블릭 서브넷 라우트 테이블
**필수 경로**:
- `0.0.0.0/0` → Internet Gateway (IGW)
- `10.0.0.0/16` (VPC 내부) → `local`

**주의**: 퍼블릭 서브넷 라우트 테이블에 S3 엔드포인트 경로가 있어도 문제없음 (태스크가 실행되지 않으므로)

## 결론

### ✅ 정상 구성
- **클러스터에 4개 서브넷 연결**: 정상
- **서비스에 프라이빗 2개만 설정**: 정상
- **실제 태스크는 프라이빗에서 실행**: 정상

### ⚠️ 확인 필요
- **서비스에 퍼블릭 서브넷이 포함되어 있다면**: 문제 가능성
- **실제 태스크가 퍼블릭 서브넷에서 실행된다면**: 보안 문제

### ✅ VPC 엔드포인트 연결
- **프라이빗 서브넷 2개만 연결**: 충분
- **퍼블릭 서브넷 연결**: 불필요하지만 문제는 없음

## 퍼블릭 IP 설정

### ⚠️ 중요: 퍼블릭 IP는 비활성화해야 함

**설정 위치**:
- ECS 서비스 → Networking → Auto-assign public IP

**올바른 설정**:
- ❌ **체크 해제 (비활성화)**

**이유**:
- 프라이빗 서브넷에서 실행되는 태스크는 퍼블릭 IP 불필요
- VPC 엔드포인트 사용 시 퍼블릭 IP 불필요
- 보안 위험 감소

자세한 내용은 `docs/ECS_PUBLIC_IP_CONFIGURATION.md` 파일을 참고하세요.

## 다음 단계

1. **서비스 설정 확인**: 프라이빗 서브넷만 선택되어 있는지 확인
2. **퍼블릭 IP 확인**: 비활성화되어 있는지 확인
3. **실제 태스크 확인**: 프라이빗 서브넷에서 실행되는지 확인
4. **VPC 엔드포인트 연결**: 프라이빗 서브넷 2개에 연결
5. **라우트 테이블 확인**: 프라이빗 서브넷의 라우트 테이블에 S3 엔드포인트 경로 확인

