# 퍼블릭 IP 비활성화 이유 및 문제 해결

## 퍼블릭 IP를 비활성화하는 이유

### 1. 보안 강화
- ✅ **태스크가 인터넷에 직접 노출되지 않음**
- ✅ **보안 그룹만으로도 충분한 보안 유지**
- ✅ **불필요한 공격 표면 감소**

### 2. 네트워크 아키텍처 일관성
- ✅ **프라이빗 서브넷의 목적과 일치**
- ✅ **VPC 엔드포인트 사용 권장**
- ✅ **AWS 모범 사례 준수**

### 3. 비용 절감
- ✅ **NAT Gateway 사용 시 불필요한 비용 절감**
- ✅ **VPC 엔드포인트만으로 충분 (ECR, S3)**

## 태스크 중지 문제 원인

### 가능한 원인들

#### 1. VPC 엔드포인트 미설정 또는 잘못 설정
**증상**:
- `CannotPullContainerError`
- `ResourceInitializationError`
- `i/o timeout`

**원인**:
- 퍼블릭 IP가 없으면 태스크가 인터넷에 직접 접근 불가
- ECR에서 이미지를 pull하려면 VPC 엔드포인트 필요
- VPC 엔드포인트가 제대로 설정되지 않았거나 연결되지 않음

**해결**:
- ECR API 엔드포인트 확인
- ECR DKR 엔드포인트 확인
- S3 Gateway 엔드포인트 확인
- 프라이빗 서브넷에 엔드포인트 연결 확인

#### 2. NAT Gateway 경로 제거
**증상**:
- 외부 서비스 접근 불가
- 특정 API 호출 실패

**원인**:
- NAT Gateway 경로를 제거했는데 외부 서비스가 필요함
- VPC 엔드포인트가 없는 AWS 서비스 접근 시도

**해결**:
- NAT Gateway 경로 복구
- 또는 필요한 VPC 엔드포인트 추가

#### 3. 보안 그룹 규칙 문제
**증상**:
- 특정 트래픽 차단
- 연결 타임아웃

**원인**:
- 보안 그룹이 VPC 엔드포인트 통신을 허용하지 않음
- 필요한 포트가 차단됨

**해결**:
- 보안 그룹 규칙 확인
- VPC 엔드포인트와 태스크 간 통신 허용

## 문제 해결 순서

### 1단계: 현재 상태 확인

**ECS 태스크 이벤트 확인**:
1. **ECS → Tasks → 중지된 태스크 선택**
2. **Details → Events** 탭 확인
3. **중지 이유 확인**:
   - `CannotPullContainerError` → ECR 접근 문제
   - `ResourceInitializationError` → 네트워크/권한 문제
   - `Essential container exited` → 애플리케이션 문제

### 2단계: VPC 엔드포인트 확인

**ECR 엔드포인트 확인**:
1. **VPC → Endpoints**
2. 다음 엔드포인트 확인:
   - `com.amazonaws.ap-northeast-2.ecr.api`
   - `com.amazonaws.ap-northeast-2.ecr.dkr`
3. **Subnets 탭**: 프라이빗 서브넷에 연결되어 있는지 확인
4. **Security 탭**: 올바른 보안 그룹 연결 확인

**S3 Gateway 엔드포인트 확인**:
1. **VPC → Endpoints**
2. `com.amazonaws.ap-northeast-2.s3` 확인
3. **Route Tables**: 프라이빗 서브넷의 라우트 테이블에 경로 확인

### 3단계: 네트워크 구성 복구

#### 옵션 1: 퍼블릭 IP 임시 활성화 (문제 해결 확인용)

**AWS 콘솔에서**:
1. **ECS → Services → 서비스 선택**
2. **Update** 클릭
3. **Networking** 섹션:
   - **Auto-assign public IP**: ✅ **체크** (임시 활성화)
4. **Update** 클릭
5. **새 태스크가 정상 실행되는지 확인**

**만약 퍼블릭 IP 활성화 시 태스크가 정상 실행되면**:
- VPC 엔드포인트 문제일 가능성 높음
- 엔드포인트 설정 확인 필요

#### 옵션 2: VPC 엔드포인트 재확인 및 수정

**ECR 엔드포인트 재확인**:
1. 엔드포인트가 모든 프라이빗 서브넷에 연결되어 있는지 확인
2. 보안 그룹이 태스크와 통신 가능한지 확인
3. Private DNS 활성화 확인

**S3 엔드포인트 재확인**:
1. 라우트 테이블에 S3 Prefix List 경로 확인
2. NAT Gateway 경로와의 우선순위 확인

### 4단계: 점진적 복구

**안전한 복구 절차**:
1. **퍼블릭 IP 활성화** → 태스크 정상 실행 확인
2. **VPC 엔드포인트 확인 및 수정**
3. **퍼블릭 IP 비활성화** → 태스크 정상 실행 확인

## 워크플로우에서 네트워크 구성 업데이트 제거 이유

### 문제점

**자동 네트워크 구성 업데이트의 문제**:
- 배포 시마다 네트워크 구성을 변경
- 네트워크 구성 변경 시 태스크가 재시작됨
- 설정 오류 시 태스크 중지
- 디버깅 어려움

### 권장 사항

**수동 설정 권장**:
- AWS 콘솔에서 한 번만 설정
- 네트워크 구성은 안정적이어야 함
- 배포 시마다 변경할 필요 없음

**워크플로우 수정**:
- 네트워크 구성 업데이트 단계 제거
- 확인 단계만 유지 (옵션)

## 결론

### 퍼블릭 IP 비활성화는 좋은 선택이지만...

**필수 조건**:
1. ✅ VPC 엔드포인트가 제대로 설정되어 있어야 함
2. ✅ 프라이빗 서브넷에 엔드포인트가 연결되어 있어야 함
3. ✅ 보안 그룹이 올바르게 설정되어 있어야 함
4. ✅ 라우트 테이블이 올바르게 설정되어 있어야 함

**현재 상황**:
- 태스크가 중지되는 것은 위 조건 중 하나가 충족되지 않았을 가능성
- 네트워크 구성을 수동으로 설정하고 안정화 확인 후 진행

### 권장 조치

1. **임시 해결**: 퍼블릭 IP 활성화하여 태스크 정상 실행 확인
2. **근본 해결**: VPC 엔드포인트 및 네트워크 설정 점검
3. **최종 설정**: 안정화 후 퍼블릭 IP 비활성화

