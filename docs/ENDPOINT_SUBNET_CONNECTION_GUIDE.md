# VPC 엔드포인트 서브넷 연결 가이드

## 상황 분석

- **총 서브넷**: 4개 (퍼블릭 2개 + 프라이빗 2개)
- **질문**: 어떤 서브넷에 엔드포인트를 연결해야 하나요?

## 답변: ECS 태스크가 실행되는 서브넷만 연결

### 핵심 원칙

**ECS 서비스에 설정된 서브넷 = 태스크가 실행될 수 있는 서브넷**

이 서브넷들에만 VPC 엔드포인트를 연결하면 됩니다.

### 1단계: ECS 서비스의 서브넷 확인 (필수)

**ECS → Services → `role-nestjs-second-service-d85kzfam` → Networking 탭**

확인할 항목:
- **Subnets**: 여기에 표시된 서브넷 ID 목록
- 일반적으로 **프라이빗 서브넷 2개**만 표시될 것입니다

**예시**:
```
Subnets:
- subnet-xxxxx (프라이빗 - 가용 영역 a)
- subnet-yyyyy (프라이빗 - 가용 영역 b)
```

### 2단계: 확인된 서브넷만 엔드포인트에 연결

**VPC → Endpoints → 각 ECR 엔드포인트 → Subnets 탭**

**연결해야 할 서브넷**:
- ✅ **ECS 서비스에 설정된 프라이빗 서브넷 2개** (필수)
- ❌ 퍼블릭 서브넷 (연결 불필요 - 태스크가 실행되지 않음)

### 이유

1. **ECS Fargate 태스크는 프라이빗 서브넷에서 실행**
   - 퍼블릭 서브넷에 태스크를 배치하지 않음
   - 따라서 퍼블릭 서브넷에 엔드포인트가 없어도 문제없음

2. **엔드포인트는 태스크가 실행되는 곳에만 필요**
   - 태스크가 없는 서브넷에 엔드포인트를 연결해도 사용되지 않음
   - 비용만 발생 (인터페이스 엔드포인트는 서브넷당 비용)

## 연결 절차

### ECR API 엔드포인트 연결

1. **VPC → Endpoints → `com.amazonaws.ap-northeast-2.ecr.api` 선택**
2. **Actions → Manage subnet associations**
3. **ECS 서비스에 설정된 프라이빗 서브넷 2개 체크**
4. **Save changes**

### ECR DKR 엔드포인트 연결

1. **VPC → Endpoints → `com.amazonaws.ap-northeast-2.ecr.dkr` 선택**
2. **Actions → Manage subnet associations**
3. **동일한 프라이빗 서브넷 2개 체크**
4. **Save changes**

### S3 엔드포인트 연결 (게이트웨이)

1. **VPC → Endpoints → `com.amazonaws.ap-northeast-2.s3` 선택**
2. **Route tables 탭 → Edit route tables**
3. **프라이빗 서브넷의 라우트 테이블 2개 선택** (서브넷이 아니라 라우트 테이블!)
4. **Save changes**

## 비용 고려사항

**VPC 인터페이스 엔드포인트 비용**:
- 시간당 약 $0.01 × 가용 영역 수
- 서브넷이 아닌 **가용 영역(AZ)당** 비용 발생

**최적화**:
- 프라이빗 서브넷만 연결 (2개 가용 영역 = 2개 서브넷)
- 불필요한 서브넷 연결 피하기 (비용 절감)

## 확인 체크리스트

배포 전 확인:

✅ **1. ECS 서비스 서브넷 확인**
   - Services → Networking 탭에서 실제 사용 서브넷 확인

✅ **2. ECR API 엔드포인트**
   - 위에서 확인한 프라이빗 서브넷 2개에 연결

✅ **3. ECR DKR 엔드포인트**
   - 위에서 확인한 프라이빗 서브넷 2개에 연결

✅ **4. S3 엔드포인트**
   - 프라이빗 서브넷의 라우트 테이블 2개에 연결

✅ **5. 보안 그룹**
   - 엔드포인트와 태스크 간 HTTPS(443) 통신 허용

## 예상 결과

올바른 서브넷에 연결하면:
- ✅ 모든 태스크가 첫 시도에 성공
- ✅ 배포 시간 단축
- ✅ 불필요한 비용 방지

