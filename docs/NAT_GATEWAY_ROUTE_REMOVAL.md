# NAT Gateway 경로 제거 가이드

## 질문: 라우트 테이블에서 NAT Gateway 경로를 지워도 되나요?

## 답변: 상황에 따라 다름

### 제거해도 되는 경우

✅ **현재 프로젝트 상황**:
- ECR: VPC 엔드포인트 있음
- S3: VPC 엔드포인트 있음
- **외부 인터넷 서비스 사용 없음**
- **다른 AWS 서비스(VPC 엔드포인트 없음) 사용 없음**

이 경우 NAT Gateway 경로를 제거해도 **기능적으로는 문제없습니다**.

### 제거하면 안 되는 경우

❌ **다음이 필요한 경우**:
- 외부 API 호출 (예: GitHub, 외부 서비스)
- npm 패키지 다운로드 (컨테이너 내부에서)
- 외부 데이터베이스 접근
- 다른 AWS 서비스 (VPC 엔드포인트 없음)
- 소프트웨어 업데이트 체크

## 안전한 테스트 방법

### 1단계: 현재 설정 백업

**라우트 테이블의 Routes 탭 스크린샷**:
- NAT Gateway 경로 기록
- 나중에 복구하기 위해

### 2단계: NAT Gateway 경로 제거

1. **VPC → Route Tables → 프라이빗 서브넷의 라우트 테이블 선택**
2. **Routes 탭 → Edit routes**
3. **`0.0.0.0/0` → `nat-gateway-xxxxx` 경로 선택 → Delete**
4. **Save changes**

### 3단계: 배포 테스트

1. **GitHub Actions로 배포 실행**
2. **결과 확인**:
   - ✅ **첫 시도 성공**: NAT Gateway가 S3 트래픽을 가로챈 것이 원인
   - ❌ **여전히 실패**: 다른 원인 (엔드포인트 자체 문제, 보안 그룹 등)

### 4단계: 결과에 따른 조치

#### 성공한 경우

**옵션 1: NAT Gateway 유지 (비용 발생)**
- NAT Gateway 경로 복구
- VPC Flow Logs로 실제 트래픽 확인
- AWS Support에 문의하여 라우팅 우선순위 문제 해결

**옵션 2: NAT Gateway 제거 (비용 절감)**
- NAT Gateway 자체 삭제 (월 약 $32.4 절감)
- VPC 엔드포인트만 사용
- ⚠️ 나중에 외부 서비스가 필요하면 다시 생성 필요

#### 여전히 실패하는 경우

- NAT Gateway 경로 복구
- 다른 원인 확인:
  - 엔드포인트 자체 문제
  - 보안 그룹 문제
  - AWS 내부 네트워크 문제

## NAT Gateway 경로 복구 방법

**테스트 후 원래대로 복구하려면**:

1. **VPC → Route Tables → 라우트 테이블 선택**
2. **Routes 탭 → Edit routes**
3. **Add route**:
   - **Destination**: `0.0.0.0/0`
   - **Target**: `nat-gateway-xxxxx` (NAT Gateway 선택)
4. **Save changes**

## 비용 고려사항

### NAT Gateway 유지
- 시간당 약 $0.045
- 월 약 $32.4
- 데이터 전송 비용 추가

### NAT Gateway 제거
- ✅ 비용 절감 (월 $32.4 + 데이터 전송 비용)
- ✅ VPC 엔드포인트만 사용 (ECR: 약 $14.4/월, S3: 무료)
- ⚠️ 나중에 외부 서비스 필요 시 다시 생성 필요

## 현재 프로젝트 권장사항

**현재 상황**:
- ECR, S3만 사용
- 외부 서비스 접근 불필요로 보임

**권장**:
1. **먼저 테스트**: NAT Gateway 경로 제거 후 배포 테스트
2. **성공하면**: NAT Gateway 자체를 삭제하여 비용 절감
3. **실패하면**: 경로 복구 후 다른 원인 확인

## 주의사항

- ⚠️ **프로덕션 환경**: 테스트 전 백업 및 복구 계획 수립
- ⚠️ **다른 서비스 영향**: 같은 VPC의 다른 리소스도 영향을 받을 수 있음
- ⚠️ **복구 가능**: 항상 경로를 다시 추가할 수 있으므로 안전하게 테스트 가능

