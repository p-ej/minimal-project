# ECS 이미지 태그 전략 가이드

## AWS ECS 이미지 버전 안정성 요구사항

### 공식 문서 요구사항

**Amazon ECS는 이미지 버전 안정성을 강제합니다.**

> "작업 정의에서 :latest 태그를 특정 버전으로 변경하세요"

### :latest 태그의 문제점

**사용하지 말아야 하는 이유**:
- ❌ 이미지가 덮어씌워질 수 있음
- ❌ 배포 시점에 다른 버전의 이미지가 pull될 수 있음
- ❌ 롤백이 어려움
- ❌ 이미지 버전 추적 불가능

### 특정 버전 태그 사용 권장

**사용해야 하는 이유**:
- ✅ 이미지 버전 안정성 보장
- ✅ 배포 시점에 정확한 버전 보장
- ✅ 롤백 용이
- ✅ 이미지 버전 추적 가능

## 현재 프로젝트 태그 전략

### 커밋 SHA 기반 태그

**현재 사용 중**:
```yaml
IMAGE_TAG: ${{ github.sha }}
```

**예시**:
```
906063354482.dkr.ecr.ap-northeast-2.amazonaws.com/minimal-project:abc123def456...
```

**장점**:
- ✅ 각 커밋마다 고유한 태그
- ✅ Git 커밋과 직접 연결
- ✅ 롤백 시 정확한 버전으로 복구 가능
- ✅ 이미지 버전 추적 용이

**단점**:
- ⚠️ 태그가 길어짐 (40자)
- ⚠️ 의미있는 버전 정보 부족

## 이미지 태그 전략 비교

### 전략 1: 커밋 SHA만 사용 (현재)

**설정**:
```yaml
IMAGE_TAG: ${{ github.sha }}
tags: ${{ env.IMAGE_URI }}
```

**예시 태그**:
- `minimal-project:abc123def456...`

**장점**:
- ✅ 간단하고 명확
- ✅ AWS 권장사항 준수
- ✅ 이미지 버전 안정성 보장

### 전략 2: 커밋 SHA + latest (권장하지 않음)

**설정**:
```yaml
IMAGE_TAG: ${{ github.sha }}
tags: |
  ${{ env.IMAGE_URI }}
  ${{ env.IMAGE_URI }}:latest
```

**예시 태그**:
- `minimal-project:abc123def456...`
- `minimal-project:latest`

**문제점**:
- ❌ `:latest` 태그 사용 시 AWS 요구사항 위반
- ❌ 태스크 정의에서 `:latest` 사용 시 오류 발생 가능
- ❌ 이미지 버전 안정성 문제

**사용 시 주의**:
- 태스크 정의에서는 **항상 특정 버전 태그만 사용**
- `:latest`는 편의를 위해만 사용 (태스크 정의에서는 사용하지 않음)

### 전략 3: 시맨틱 버전 + 커밋 SHA

**설정**:
```yaml
IMAGE_TAG: v1.0.0-${{ github.sha }}
```

**예시 태그**:
- `minimal-project:v1.0.0-abc123def456...`

**장점**:
- ✅ 의미있는 버전 정보
- ✅ 특정 버전 태그 사용
- ✅ 버전 추적 용이

## 현재 구현

### 워크플로우 설정

**이미지 태그**:
```yaml
env:
  IMAGE_TAG: ${{ github.sha }}  # 커밋 SHA 사용
```

**Docker 빌드**:
```yaml
tags: ${{ env.IMAGE_URI }}  # 특정 버전 태그만 사용
```

**태스크 정의 렌더링**:
```yaml
image: ${{ env.IMAGE_URI }}  # 특정 버전 태그 사용
```

### 검증 단계

**태스크 정의 검증**:
- `:latest` 태그 사용 여부 확인
- 특정 버전 태그 형식 검증
- 오류 시 배포 중단

## AWS 요구사항 준수 확인

### ✅ 현재 구성 준수

1. **특정 버전 태그 사용**: ✅ 커밋 SHA 사용
2. **`:latest` 태그 미사용**: ✅ 태스크 정의에서 사용하지 않음
3. **이미지 버전 안정성**: ✅ 각 배포마다 고유한 태그
4. **검증 단계**: ✅ 태스크 정의에서 `:latest` 사용 방지

### 검증 프로세스

**워크플로우에서 자동 검증**:
1. 이미지 푸시 후 ECR 존재 확인
2. 태스크 정의 렌더링 후 이미지 URI 확인
3. `:latest` 태그 사용 여부 확인
4. 특정 버전 태그 형식 검증

## 추가 권장 사항

### 1. 이미지 태그 명명 규칙

**현재 규칙**:
- 커밋 SHA 전체 사용 (40자)

**대안**:
- 커밋 SHA 짧은 버전 (7자): `git rev-parse --short HEAD`
- 시맨틱 버전 + SHA: `v1.0.0-abc1234`

### 2. 이미지 태그 관리

**ECR 이미지 정리**:
- 오래된 이미지 자동 삭제 정책 설정
- 특정 태그만 유지 (예: 최근 10개)

**태그 전략 문서화**:
- 팀 내 태그 전략 공유
- 배포 가이드에 태그 전략 포함

## 문제 해결

### 오류: ":latest 태그를 특정 버전으로 변경하세요"

**원인**:
- 태스크 정의에서 `:latest` 태그 사용
- 또는 이미지 URI에 `:latest` 포함

**해결**:
1. 태스크 정의 확인: `ecs-task-def.json`에서 `image` 필드 확인
2. 워크플로우 확인: `IMAGE_TAG` 환경변수 확인
3. 렌더링 확인: 렌더링된 태스크 정의에서 이미지 URI 확인

### 오류: "이미지를 더 이상 사용할 수 없습니다"

**원인**:
- 이미지가 ECR에서 삭제됨
- 이미지 태그가 변경됨

**해결**:
1. ECR에서 이미지 존재 확인
2. 이미지 태그 확인
3. 이미지 검증 단계 확인

## 요약

### ✅ 현재 구성

- **태그 전략**: 커밋 SHA 기반 특정 버전 태그
- **`:latest` 사용**: ❌ 사용하지 않음 (AWS 요구사항 준수)
- **검증**: ✅ 자동 검증 단계 포함

### 📋 권장 사항

1. **태그 전략 유지**: 커밋 SHA 기반 태그 계속 사용
2. **`:latest` 사용 금지**: 태스크 정의에서 절대 사용하지 않음
3. **검증 단계 유지**: 자동 검증으로 오류 조기 감지

### 🔧 AWS 요구사항 준수

- ✅ 특정 버전 태그 사용
- ✅ 이미지 버전 안정성 보장
- ✅ 롤백 가능
- ✅ 버전 추적 가능

