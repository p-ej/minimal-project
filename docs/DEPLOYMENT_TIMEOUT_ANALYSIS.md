# ECS 배포 타임아웃 및 태스크 실패 원인 분석 및 해결

## 문제 상황 요약

- ✅ **최종 배포 성공**: 새로운 태스크가 정상 실행됨
- ❌ **배포 시간**: 15분 (정상보다 길음)
- ❌ **중간 실패**: 태스크가 2-3번 실패 후 성공
- ❌ **에러**: `CannotPullContainerError` - ECR 이미지 pull 타임아웃

## 핵심 원인 분석

**"일부 태스크는 실패하고 일부는 성공"**하는 것은 **네트워크 경로가 불안정**하다는 의미입니다.

가능한 원인:
1. **VPC 엔드포인트가 모든 가용 영역/서브넷에 연결되지 않음**
2. **ECS 태스크가 여러 가용 영역에서 실행되는데, 일부 가용 영역에는 엔드포인트가 없음**
3. **보안 그룹 규칙이 일부 통신만 허용**
4. **Private DNS가 일관되지 않게 작동**

## 단계별 진단 및 해결

### 1단계: ECS 태스크 실행 서브넷 확인

**목적**: 태스크가 어떤 서브넷에서 실행되는지 확인

**✅ 일반적인 구성 (정상)**:
- **퍼블릭 서브넷 2개**: 각 가용 영역(AZ)마다 1개씩
- **프라이빗 서브넷 2개**: 각 가용 영역(AZ)마다 1개씩
- **총 4개 서브넷**: 2개 AZ × 2개 서브넷 타입 = 4개

**⚠️ 중요**: ECS 클러스터에 연결된 서브넷이 4개라고 해서, **모든 서브넷에서 태스크가 실행되는 것은 아닙니다**.

**확인 방법**:
1. **ECS → Clusters → `cluster-nestjs-second` → Services → `role-nestjs-second-service-d85kzfam`**
2. **Networking 탭** 확인
3. **Subnets** 목록 기록 (예: `subnet-xxxxx-a`, `subnet-yyyyy-b`)
   - ⚠️ **중요**: ECS 서비스에 **실제로 설정된 서브넷만** 확인
   - 일반적으로 **프라이빗 서브넷만** 사용 (Fargate의 경우)
   - ✅ **4개 모두 연결되어 있어도 정상** (다중 AZ 배포를 위해)
   - ✅ **하지만 실제 태스크는 프라이빗 서브넷에서만 실행됨**

**또는 실행 중인 태스크로 확인**:
1. **ECS → Tasks → 실행 중인 태스크 선택**
2. **Details 탭 → Network** 섹션
3. **Subnet ID** 확인
4. **여러 태스크 확인하여 모든 서브넷 ID 수집**

**결정 원칙**:
- ✅ **ECS 서비스에 설정된 서브넷만** 엔드포인트에 연결
- ✅ 일반적으로 **프라이빗 서브넷만** 연결 (Fargate 태스크는 프라이빗에서 실행)
- ❌ 퍼블릭 서브넷은 연결 불필요 (태스크가 실행되지 않으므로)

또는

1. **ECS → Tasks → 실행 중인 태스크 선택**
2. **Details 탭 → Network** 섹션
3. **Subnet ID** 확인
4. **여러 태스크 확인하여 모든 서브넷 ID 수집**

### 2단계: VPC 엔드포인트 서브넷 확인

**목적**: 엔드포인트가 태스크와 같은 서브넷에 있는지 확인

**확인 방법**:
1. **VPC → Endpoints**
2. 다음 2개 엔드포인트 확인:
   - `com.amazonaws.ap-northeast-2.ecr.api`
   - `com.amazonaws.ap-northeast-2.ecr.dkr`
3. 각 엔드포인트 선택 → **Subnets 탭**
4. **연결된 서브넷 목록 확인**

**문제 확인**:
- ❌ 태스크 서브넷이 엔드포인트 서브넷 목록에 **없다** → 문제 발견!
- ✅ 모든 태스크 서브넷이 엔드포인트에 포함되어 있다 → 다음 단계

### 3단계: 엔드포인트 수정 (서브넷 추가)

**만약 태스크 서브넷이 엔드포인트에 없다면**:

1. **VPC → Endpoints → 엔드포인트 선택**
2. **Actions → Manage subnet associations**
3. **누락된 서브넷 체크** (1단계에서 확인한 태스크 서브넷)
4. **Save changes**
5. **다른 ECR 엔드포인트도 동일하게 수정**

**중요**: 
- ECR API와 ECR DKR 엔드포인트 **둘 다** 모든 태스크 서브넷에 연결되어야 함
- **가용 영역별로 서브넷이 다를 수 있으므로 모든 가용 영역의 서브넷 확인**

### 4단계: 보안 그룹 확인 및 수정

**목적**: 엔드포인트와 태스크 간 통신이 보안 그룹에서 막혀있는지 확인

#### 4-1. 태스크 보안 그룹 확인

1. **ECS → Services → 서비스 선택 → Networking 탭**
2. **Security groups** 확인 (예: `sg-xxxxx`)

#### 4-2. 엔드포인트 보안 그룹 확인

1. **VPC → Endpoints → 각 ECR 엔드포인트 → Security 탭**
2. **Security groups** 확인

#### 4-3. 보안 그룹 규칙 확인

**ECR 엔드포인트 보안 그룹 인바운드 규칙**:
```
Type: HTTPS
Protocol: TCP
Port: 443
Source: 태스크 보안 그룹 ID (sg-xxxxx) 또는 0.0.0.0/0
```

**태스크 보안 그룹 아웃바운드 규칙**:
```
Type: HTTPS
Protocol: TCP
Port: 443
Destination: 0.0.0.0/0 (또는 엔드포인트 보안 그룹)
```

**수정 방법** (문제가 있다면):

**옵션 1: 같은 보안 그룹 사용** (가장 간단)
1. **VPC → Endpoints → 엔드포인트 선택 → Actions → Modify security groups**
2. **태스크와 같은 보안 그룹 추가**
3. **Save changes**

**옵션 2: 보안 그룹 규칙 추가**
- 엔드포인트 보안 그룹 인바운드에 태스크 보안 그룹 추가

### 5단계: Private DNS 확인

**목적**: DNS가 올바르게 리졸브되는지 확인

**확인 방법**:
1. **VPC → Endpoints → 각 ECR 엔드포인트 → Details 탭**
2. **Private DNS enabled** = `Yes`인지 확인

**문제가 있다면**:
- **Actions → Modify private DNS settings**
- **Enable private DNS name** 체크
- **Save changes**

### 6단계: S3 엔드포인트 라우트 테이블 확인

**목적**: S3 엔드포인트가 모든 태스크 서브넷의 라우트 테이블에 추가되었는지 확인

**확인 방법**:
1. **VPC → Route Tables**
2. **각 태스크 서브넷의 라우트 테이블 선택** (1단계에서 확인한 서브넷)
3. **Routes 탭** 확인
4. **`pl-xxxxx` (S3 Prefix List) → `vpce-xxxxx` (S3 엔드포인트)** 경로가 있는지 확인

**없다면**:
- **VPC → Endpoints → S3 엔드포인트 선택**
- **Route tables 탭 → Edit route tables**
- **누락된 라우트 테이블 추가**
- **Save changes**

### 7단계: 실제 연결 테스트 (ECS Exec)

**목적**: 태스크 내부에서 ECR 연결을 직접 테스트

**방법**:
1. **ECS → Clusters → 클러스터 선택 → Tasks 탭**
2. **실행 중인 태스크 선택 → Connect**
3. **ECS Exec 활성화 필요** (처음 사용 시)
4. **태스크 내부에서 실행**:
   ```bash
   # DNS 확인
   nslookup 906063354482.dkr.ecr.ap-northeast-2.amazonaws.com
   
   # 연결 테스트
   curl -v https://906063354482.dkr.ecr.ap-northeast-2.amazonaws.com
   ```

**예상 결과**:
- ✅ DNS가 엔드포인트 IP로 리졸브됨
- ✅ 연결 성공 (200 또는 401 응답)
- ❌ 타임아웃 → 네트워크 문제

### 8단계: CloudWatch 로그 분석

**목적**: 실패 태스크의 정확한 에러 시점과 IP 확인

**확인 방법**:
1. **ECS → Services → 서비스 선택 → Logs 탭**
2. **실패한 태스크의 로그 확인**
3. **에러 메시지의 IP 주소 기록** (예: `52.219.148.62`, `3.5.188.35`)
4. **VPC → Endpoints → 엔드포인트 선택 → Network interfaces 탭**
5. **엔드포인트의 Private IP 확인**
6. **비교**: 에러의 IP가 엔드포인트 IP와 일치하는가?

**결과 분석**:
- **일치함**: 엔드포인트로 라우팅되지만 연결 실패 → 보안 그룹 문제 가능
- **일치하지 않음**: 인터넷으로 라우팅됨 → 엔드포인트가 제대로 연결되지 않음

## 종합 해결 체크리스트

배포를 다시 실행하기 전에 다음을 모두 확인:

### 필수 확인 사항

✅ **1. 태스크 실행 서브넷 파악**
   - ECS 서비스의 Networking 탭에서 모든 서브넷 확인

✅ **2. ECR API 엔드포인트**
   - 모든 태스크 서브넷에 연결됨
   - Private DNS 활성화
   - 보안 그룹 규칙 올바름

✅ **3. ECR DKR 엔드포인트**
   - 모든 태스크 서브넷에 연결됨
   - Private DNS 활성화
   - 보안 그룹 규칙 올바름

✅ **4. S3 엔드포인트**
   - 모든 태스크 서브넷의 라우트 테이블에 추가됨

✅ **5. 보안 그룹**
   - 엔드포인트와 태스크 간 HTTPS(443) 통신 허용

✅ **6. 태스크 실행 역할**
   - ECR 권한 (`AmazonECSTaskExecutionRolePolicy`) 있음

## 예상 결과

위 체크리스트를 모두 완료하면:
- ✅ 모든 태스크가 첫 시도에 성공
- ✅ 배포 시간 단축 (15분 → 2-3분)
- ✅ 실패 태스크 없음
- ✅ 안정적인 배포

## 추가 모니터링

해결 후에도 다음을 모니터링:
1. **CloudWatch Metrics**: ECS 태스크 성공률
2. **CloudWatch Logs**: 실패 태스크 에러 로그
3. **VPC Flow Logs**: 네트워크 트래픽 패턴 (선택사항)

## 진행 상황: 서브넷 연결 후에도 실패 발생

### 현재 상황
- ✅ 실패 시도 감소: 2-3번 → 1번
- ❌ 여전히 실패 발생: 첫 시도 실패, 재시도 성공
- ❌ 배포 시간: 15분 → 11분 (개선되었지만 여전히 길음)

### 남은 문제 원인 분석

**에러 메시지 분석**:
```
dial tcp 52.219.204.42:443: i/o timeout
```

**중요 발견**: IP 주소(`52.219.204.42`)가 **S3 관련 아마존 사이트**로 확인됨

**이것은 S3 엔드포인트 문제입니다!**

ECR은 이미지를 pull할 때:
1. ✅ ECR API/DKR 엔드포인트로 이미지 메타데이터 가져오기 (성공)
2. ❌ S3에서 이미지 레이어 다운로드 (실패) ← 현재 문제

ECR은 이미지 레이어를 S3에 저장하고, pull 시 S3에서도 레이어를 다운로드해야 합니다.

### 추가 진단 단계

#### A단계: DNS 리졸브 확인

**문제**: Private DNS가 제대로 작동하지 않아 인터넷 IP로 연결 시도

**확인 방법**:
1. **VPC → Endpoints → ECR DKR 엔드포인트 선택**
2. **Network interfaces 탭**
3. **각 네트워크 인터페이스의 Private IP 주소 확인** (예: `10.0.x.x`)
4. **에러의 IP 주소(`52.219.204.42`)와 비교**

**결과 분석**:
- ✅ **일치함**: 엔드포인트 IP로 연결 시도했지만 타임아웃 → 보안 그룹 문제 가능
- ❌ **일치하지 않음**: 인터넷 IP로 연결 시도 → Private DNS 문제

#### B단계: Private DNS 재확인 및 수정

**만약 DNS 문제라면**:

1. **VPC → Endpoints → 각 ECR 엔드포인트 선택**
2. **Details 탭 → Private DNS enabled = Yes 확인**
3. **아니라면 수정**:
   - Actions → Modify private DNS settings
   - Enable private DNS name 체크
   - Save changes

4. **엔드포인트 DNS 이름 확인**:
   - ECR API: `ecr.api.ap-northeast-2.amazonaws.com`
   - ECR DKR: `*.dkr.ecr.ap-northeast-2.amazonaws.com`
   - 이 이름들이 프라이빗 IP로 리졸브되어야 함

#### C단계: 보안 그룹 상세 확인

**문제**: 보안 그룹 규칙이 엔드포인트와 태스크 간 통신을 완전히 허용하지 않음

**확인 방법**:

1. **태스크 보안 그룹 확인**:
   - ECS → Services → 서비스 선택 → Networking 탭
   - Security groups ID 기록 (예: `sg-xxxxx`)

2. **엔드포인트 보안 그룹 확인**:
   - VPC → Endpoints → 각 ECR 엔드포인트 → Security 탭
   - Security groups ID 기록

3. **양방향 통신 규칙 확인**:

   **엔드포인트 보안 그룹 인바운드**:
   ```
   Type: HTTPS
   Protocol: TCP
   Port: 443
   Source: 태스크 보안 그룹 ID (sg-xxxxx)
   ```

   **태스크 보안 그룹 아웃바운드**:
   ```
   Type: HTTPS
   Protocol: TCP
   Port: 443
   Destination: 엔드포인트 보안 그룹 ID 또는 0.0.0.0/0
   ```

**수정 방법 (가장 확실한 방법)**:

**옵션 1: 같은 보안 그룹 사용** (권장)
1. **VPC → Endpoints → 각 ECR 엔드포인트 선택**
2. **Actions → Modify security groups**
3. **태스크와 같은 보안 그룹을 추가** (또는 기존 보안 그룹 교체)
4. **Save changes**

이렇게 하면 같은 보안 그룹 내부 통신이므로 자동으로 허용됩니다.

#### D단계: 가용 영역 불일치 확인

**문제**: 태스크가 예상치 못한 가용 영역에서 실행됨

**확인 방법**:
1. **ECS → Tasks → 최근 실패한 태스크 선택**
2. **Details 탭 → Network → Availability Zone 확인**
3. **VPC → Endpoints → 엔드포인트 → Subnets 탭**
4. **태스크가 실행된 가용 영역의 서브넷이 엔드포인트에 연결되어 있는지 확인**

**없다면**:
- 해당 가용 영역의 프라이빗 서브넷을 엔드포인트에 추가

#### E단계: S3 엔드포인트 확인 및 수정 (가장 중요!)

**문제**: S3 엔드포인트가 제대로 설정되지 않아 S3에서 이미지 레이어를 다운로드할 수 없음

**확인 방법**:

1. **S3 엔드포인트 존재 확인**:
   - VPC → Endpoints
   - `com.amazonaws.ap-northeast-2.s3` 엔드포인트가 있는지 확인

2. **S3 엔드포인트가 올바른 라우트 테이블에 연결되었는지 확인**:
   - VPC → Route Tables
   - **프라이빗 서브넷의 라우트 테이블 선택** (ECS 태스크가 사용하는 서브넷)
   - Routes 탭 확인
   - **`pl-xxxxx` (S3 Prefix List) → `vpce-xxxxx` (S3 엔드포인트)** 경로가 있는지 확인

**문제가 있다면**:

**S3 엔드포인트가 없는 경우**:
1. **VPC → Endpoints → Create Endpoint**
2. **Service category**: AWS services
3. **Service name**: `com.amazonaws.ap-northeast-2.s3` 검색 및 선택
4. **VPC**: 태스크가 실행되는 VPC 선택
5. **Route tables**: **프라이빗 서브넷의 라우트 테이블 선택** (서브넷이 아님!)
   - ⚠️ **중요**: S3는 게이트웨이 엔드포인트이므로 **라우트 테이블**에 연결
6. **Policy**: Full access
7. **Create endpoint**

**S3 엔드포인트가 있지만 라우트 테이블에 없는 경우**:
1. **VPC → Endpoints → S3 엔드포인트 선택**
2. **Route tables 탭 → Edit route tables**
3. **프라이빗 서브넷의 라우트 테이블 추가** (모든 태스크 서브넷의 라우트 테이블)
4. **Save changes**

**확인 방법**:
- Route Tables → Routes 탭에서 다음과 같은 경로가 보여야 함:
  ```
  Destination: pl-xxxxx (10.0.0.0/8)
  Target: vpce-xxxxx (S3 엔드포인트)
  ```

#### F단계: 네트워크 ACL 확인

**문제**: 네트워크 ACL이 엔드포인트 통신을 차단

**확인 방법**:
1. **VPC → Network ACLs**
2. **프라이빗 서브넷의 네트워크 ACL 선택**
3. **인바운드 규칙**:
   - "모든 트래픽 허용" 규칙이 있는지 확인
   - 또는 HTTPS (443) 허용 규칙이 있는지 확인
4. **아웃바운드 규칙**:
   - "모든 트래픽 허용" 규칙이 있는지 확인
   - 또는 HTTPS (443) 허용 규칙이 있는지 확인

**규칙 확인**:
- ✅ **"모든 트래픽 허용" 규칙이 있으면**: 443 포트 자동 포함 (별도 추가 불필요)
- ❌ **허용 규칙이 없거나 거부 규칙만 있으면**: HTTPS(443) 허용 규칙 추가 필요

**문제가 있다면**:
- "모든 트래픽 허용" 규칙 추가 (간단)
- 또는 인바운드/아웃바운드에 HTTPS(443) 규칙 추가 (구체적)

**주의사항**:
- Network ACL 규칙은 **우선순위**가 있습니다 (낮은 번호 = 높은 우선순위)
- 거부 규칙이 허용 규칙보다 우선순위가 높으면 통신이 차단될 수 있음

### 우선순위별 해결 방법

**가장 가능성 높은 순서** (S3 IP 확인 후):

1. **S3 엔드포인트 확인 및 수정** (최우선!)
   - S3 엔드포인트가 존재하는지 확인
   - 프라이빗 서브넷의 **라우트 테이블**에 S3 엔드포인트 경로가 있는지 확인
   - 없다면 추가 (게이트웨이 엔드포인트는 라우트 테이블에 연결)

2. **보안 그룹을 같은 그룹으로 통일**
   - 엔드포인트와 태스크가 같은 보안 그룹 사용
   - ECR API/DKR 엔드포인트에도 적용

3. **Private DNS 재확인** (ECR 엔드포인트만 해당)
   - ECR API 엔드포인트에서 Private DNS 활성화 확인
   - ECR DKR 엔드포인트에서 Private DNS 활성화 확인
   - ⚠️ **S3 엔드포인트는 게이트웨이 엔드포인트이므로 Private DNS 옵션이 없음** (정상)

4. **가용 영역 확인**
   - 실패한 태스크의 가용 영역 확인
   - 해당 가용 영역의 서브넷이 엔드포인트에 연결되어 있는지 확인

5. **네트워크 ACL 확인**
   - 프라이빗 서브넷의 네트워크 ACL에서 HTTPS 허용 확인

### 예상 결과

위 조치 후:
- ✅ 첫 시도 성공
- ✅ 배포 시간: 11분 → 2-3분
- ✅ 실패 태스크 없음

## 모든 체크리스트 확인 후에도 문제가 지속되는 경우

### 추가 진단 단계

#### G단계: 라우트 테이블 우선순위 확인

**문제**: 다른 경로(예: NAT Gateway)가 S3 엔드포인트보다 우선순위가 높아서 S3 엔드포인트로 라우팅되지 않음

**확인 방법**:
1. **VPC → Route Tables → 프라이빗 서브넷의 라우트 테이블 선택**
2. **Routes 탭**에서 모든 경로 확인
3. **다음과 같은 경로가 있는지 확인**:
   ```
   Destination          Target
   0.0.0.0/0            nat-gateway-xxxxx (NAT Gateway)
   pl-xxxxx (S3)        vpce-xxxxx (S3 엔드포인트)
   ```

**문제 발견**:
- ❌ `0.0.0.0/0` → NAT Gateway 경로가 있고, S3 Prefix List 경로가 없거나 우선순위가 낮음
- ✅ S3 Prefix List 경로가 NAT Gateway보다 먼저 평가되도록 설정 필요

**해결 방법**:
- S3 엔드포인트의 Prefix List가 더 구체적이므로 자동으로 우선순위가 높아야 함
- 하지만 NAT Gateway의 `0.0.0.0/0`이 모든 트래픽을 가져가면 문제 발생
- **확인**: S3 Prefix List 경로가 실제로 존재하는지, 그리고 라우트 테이블에 제대로 추가되었는지

#### H단계: 실제 태스크 서브넷의 라우트 테이블 재확인

**문제**: 확인한 라우트 테이블이 실제 태스크가 사용하는 서브넷의 라우트 테이블과 다를 수 있음

**확인 방법**:
1. **ECS → Tasks → 최근 실패한 태스크 선택**
2. **Details 탭 → Network → Subnet ID 확인** (예: `subnet-xxxxx`)
3. **VPC → Subnets → 해당 서브넷 선택**
4. **Route table 탭 → 실제 연결된 라우트 테이블 확인**
5. **이 라우트 테이블에 S3 엔드포인트 경로가 있는지 확인**

**중요 포인트**:
- ⚠️ **라우트 테이블은 여러 서브넷에 연결될 수 있습니다**
- ✅ **프라이빗 서브넷이 연결된 라우트 테이블**에 S3 엔드포인트 경로가 있으면 됩니다
- ✅ 퍼블릭 서브넷도 같은 라우트 테이블을 사용해도 문제 없습니다 (태스크가 실행되지 않으므로)
- ⚠️ **각 프라이빗 서브넷이 다른 라우트 테이블을 사용하는 경우**, 모든 프라이빗 서브넷의 라우트 테이블을 확인해야 합니다

**확인 절차**:
1. **실패한 태스크의 서브넷 ID 확인** (프라이빗 서브넷)
2. **해당 서브넷의 라우트 테이블 확인**
3. **라우트 테이블의 Routes 탭에서 S3 Prefix List 경로 확인**
4. **다른 프라이빗 서브넷도 같은 라우트 테이블을 사용하는지 확인**
   - 같다면: 하나의 라우트 테이블만 확인하면 됨
   - 다르다면: 각 프라이빗 서브넷의 라우트 테이블을 모두 확인

#### I단계: S3 엔드포인트 Prefix List 확인

**문제**: S3 엔드포인트가 생성되었지만 Prefix List가 올바르게 설정되지 않음

**확인 방법**:
1. **VPC → Route Tables → 프라이빗 서브넷의 라우트 테이블 → Routes 탭**
2. **S3 엔드포인트 경로 확인**:
   ```
   Destination: pl-xxxxx
   Target: vpce-xxxxx
   ```
3. **Prefix List ID 클릭하여 상세 정보 확인**
4. **Prefix List의 CIDR 범위 확인** (S3 IP 범위가 포함되어야 함)

**문제가 있다면**:
- S3 엔드포인트 재생성
- 또는 다른 리전의 S3 엔드포인트가 있는지 확인 (잘못된 리전)

#### J단계: VPC Flow Logs 확인 (고급 진단)

**문제**: 실제 트래픽이 어디로 가는지 확인 필요

**설정 방법** (필요한 경우):
1. **VPC → Flow Logs → Create Flow Log**
2. **필터**: All
3. **Destination**: CloudWatch Logs
4. **생성 후 일정 시간 대기**

**확인 방법**:
1. **CloudWatch → Log groups → VPC Flow Logs**
2. **실패한 태스크의 시간대 로그 확인**
3. **S3 관련 트래픽이 어디로 라우팅되는지 확인**:
   - `vpce-xxxxx`로 가는지 (엔드포인트)
   - `nat-gateway-xxxxx`로 가는지 (NAT Gateway)
   - `igw-xxxxx`로 가는지 (인터넷 게이트웨이)

#### K단계: CloudWatch 네트워크 메트릭 확인

**ECS → Services → 서비스 선택 → Metrics 탭**

확인할 메트릭:
- **NetworkRxBytes**: 네트워크 수신 바이트
- **NetworkTxBytes**: 네트워크 전송 바이트

태스크가 시작될 때 네트워크 트래픽이 있는지 확인:
- ✅ 트래픽 있음: 네트워크는 작동하지만 특정 서비스(ECR/S3) 접근 실패
- ❌ 트래픽 없음: 네트워크 자체 문제

#### L단계: ECS 태스크 네트워크 모드 확인

**ecs-task-def.json 확인**:
```json
"networkMode": "awsvpc"
```

이 설정이 올바른지 확인:
- ✅ `awsvpc`: 태스크가 VPC 네트워크 사용 (엔드포인트 사용 가능)
- ❌ 다른 모드: 엔드포인트 사용 불가

### 최종 해결 방법

위 단계를 모두 확인해도 문제가 지속되면:

1. **S3 엔드포인트 재생성**:
   - 기존 엔드포인트 삭제
   - 새로 생성 (모든 라우트 테이블에 추가)

2. **라우트 테이블 수동 확인**:
   - **프라이빗 서브넷이 연결된 라우트 테이블**을 확인
   - 같은 라우트 테이블을 사용한다면 하나만 확인, 다르다면 각각 확인
   - Routes 탭에서 `pl-xxxxx` (S3 Prefix List) → `vpce-xxxxx` (S3 엔드포인트) 경로가 정확히 있는지 확인
   - ⚠️ **서브넷이 아니라 라우트 테이블**에 경로가 있어야 함

3. **S3 Prefix List CIDR 범위 확인** (✅ 확인 완료):
   - Prefix List에 `52.219.204.0/22` 포함됨
   - 에러 IP `52.219.204.42`는 이 범위에 포함됨 (정상)
   - **Prefix List는 올바르게 설정되어 있음**

4. **라우트 테이블 경로 우선순위 및 실제 라우팅 확인** (가장 중요):
   
   **이론상**: Prefix List(`52.219.204.0/22`)가 `0.0.0.0/0`보다 구체적이므로 자동으로 우선 선택되어야 함
   
   **하지만 실제로는**:
   - NAT Gateway가 먼저 트래픽을 가로챌 수 있음
   - 또는 라우트 테이블 평가 순서 문제
   
   **확인 방법**:
   - Routes 탭에서 모든 경로를 확인
   - S3 Prefix List 경로가 존재하는지 확인
   - `0.0.0.0/0` → NAT Gateway 경로도 있는지 확인
   
   **해결 방법**:
   - VPC Flow Logs로 실제 트래픽 경로 확인 (가장 확실)
   - 또는 NAT Gateway 경로를 일시적으로 비활성화하여 테스트 (주의 필요)

   **⚠️ NAT Gateway 경로 제거 시 주의사항**:
   - ✅ **VPC 엔드포인트가 있는 서비스**: ECR, S3는 엔드포인트로 접근 가능
   - ❌ **다른 인터넷 서비스**: 외부 API, 패키지 다운로드 등이 차단됨
   - ❌ **다른 AWS 서비스**: VPC 엔드포인트가 없는 서비스 접근 불가
   - ✅ **현재 프로젝트**: ECR, S3만 사용한다면 NAT Gateway 불필요할 수 있음
   
   **안전한 테스트 방법**:
   1. **백업**: 현재 라우트 테이블 설정 기록 (스크린샷)
   2. **임시 제거**: NAT Gateway 경로(`0.0.0.0/0` → `nat-gateway-xxxxx`) 삭제
   3. **배포 테스트**: 배포 실행하여 첫 시도 성공하는지 확인
   4. **결과 확인**:
      - ✅ 성공: NAT Gateway가 S3 트래픽을 가로챈 것이 원인
      - ❌ 여전히 실패: 다른 원인 (엔드포인트 자체 문제 등)
   5. **복구**: 테스트 후 필요하면 NAT Gateway 경로 다시 추가

5. **VPC Flow Logs로 실제 트래픽 확인** (가장 확실한 방법):
   - VPC → Flow Logs → Create Flow Log (없다면 생성)
   - 실패한 태스크의 시간대 로그 확인
   - S3 트래픽(`52.219.204.42`)이 어디로 가는지 확인:
     - `vpce-xxxxx`로 가는지 (엔드포인트 사용 중)
     - `nat-gateway-xxxxx`로 가는지 (NAT Gateway 사용 중)
     - `igw-xxxxx`로 가는지 (인터넷 게이트웨이 사용 중)

6. **AWS Support 문의**:
   - VPC Flow Logs와 함께 문제 상세 설명
   - AWS 내부 네트워크 문제일 수 있음

## 빠른 수정 방법 (임시)

만약 급하게 배포해야 한다면:
1. **ECS 서비스 설정 → Deployment Configuration**
2. **Maximum percent**: 100% → 200% (더 많은 태스크 동시 생성)
3. **Minimum healthy percent**: 50% → 0% (임시)
4. 실패 태스크가 더 빨리 재시도되지만 근본 해결은 아님

**주의**: 근본 해결은 위의 체크리스트를 모두 완료하는 것입니다.

